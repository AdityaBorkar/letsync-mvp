import { pgSchema, serial, text, timestamp, uuid } from "drizzle-orm/pg-core"

export const letsync = pgSchema("letsync")

export const clientMetadataType = letsync.enum("client_metadata_type", [
  "string",
  "boolean",
  "object"
])

export const clientMetadata = letsync.table("client_metadata", {
  key: text().primaryKey(),
  type: clientMetadataType().notNull(),
  value: text().notNull()
})

export const clientSchemas = letsync.table("client_schemas", {
  created_at: timestamp().defaultNow().notNull(),
  idx: serial().primaryKey(),
  // is_rolled_back: boolean().default(false).notNull(),
  sql_init: text().notNull(),
  sql_migration: text().notNull(),
  tag: text()
})

export const mutationStatus = letsync.enum("mutation_status", [
  "pending",
  "processing",
  "completed",
  "failed"
])

export const clientMutations = letsync.table("client_mutations", {
  created_at: timestamp().defaultNow().notNull(),
  mutation_name: text().notNull(),
  request_id: uuid().notNull(),
  status: mutationStatus().notNull()
})

// export const cdc = letsync.table("cdc", {
//   action: text().notNull(), // 'archived' | 'marked as completed' | 'execution started' | 'execution cancelled' | Custom Text
//   data: jsonb().notNull(), // Transformations only
//   id: text().$defaultFn(() => createId()),
//   item_id: text().notNull(), // tableName_rowId (non-indexed)
//   operation: text({ enum: ["create", "update", "delete"] }).notNull(),
//   tenant_id: uuid(),
//   timestamp: timestamp().notNull(), // Cursor
//   user_id: uuid().notNull()
// })

// export const cdcCache = letsync.table("cdc_cache", {
//   _client_applied_at: timestamp(),
//   end: text().notNull(),
//   id: text().$defaultFn(() => createId()),
//   start: text().notNull(),
//   storage_url: text().notNull(),
//   tenant_id: uuid(),
//   timestamp: timestamp().notNull()
// })

// TODO: Mutations and executing them in the client-server spaces. Experiment in /test endpoint.
// Go to #letsync/client/ws/messages/data-operations.ts and construct SQL Queries with transactions
// Also sync CDC Records to the client.
// Basic Conflice Resolution - Last Write Wins.
// insert into tenants (id, name) values ('d24419bf-6122-4879-afa5-1d9c1b051d72', 'my first customer');
// select * from tenants;

// insert into todos (tenant_id, title, estimate, embedding, complete) values ('d24419bf-6122-4879-afa5-1d9c1b051d72', 'feed my cat', '1h', '[1,2,3]', false);

// SELECT tenants.name, title, embedding, estimate, complete
// FROM todos join tenants on tenants.id = todos.tenant_id;
